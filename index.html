<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>CogCapture</title>
<link rel="icon" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'%3E%3Crect width='100' height='100' rx='20' fill='%23c26a3a'/%3E%3Ctext x='50' y='70' font-family='sans-serif' font-size='60' font-weight='bold' fill='white' text-anchor='middle'%3EC%3C/text%3E%3C/svg%3E" type="image/svg+xml">
<link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;500;600;700&family=IBM+Plex+Mono:wght@400;500&display=swap" rel="stylesheet">
<style>
  /* ─── THEME SYSTEM ─── */
  :root, [data-theme="light"] {
    --bg: #f7f3ec;
    --bg-surface: #ffffff;
    --bg-elevated: #fff;
    --bg-hover: #f0ebe2;
    --bg-nav: #f0ebe2;
    --border: #e0d8cc;
    --border-subtle: #e8e1d5;
    --text: #3a352e;
    --text-secondary: #6b6558;
    --text-muted: #b0a898;
    --accent: #c26a3a;
    --accent-dim: #a3552e;
    --accent-glow: rgba(194, 106, 58, 0.10);
    --action: #5a8a52;
    --action-bg: rgba(90, 138, 82, 0.10);
    --reference: #5a82aa;
    --reference-bg: rgba(90, 130, 170, 0.10);
    --done: #b0a898;
    --danger: #b85450;
    --danger-bg: rgba(184, 84, 80, 0.08);
    --pinned: #c9a84c;
    --pinned-bg: rgba(201, 168, 76, 0.10);
    --undo-bg: #3a352e;
    --undo-text: #f7f3ec;
    --modal-overlay: rgba(247, 243, 236, 0.8);
  }

  [data-theme="dark"] {
    --bg: #1c1a16;
    --bg-surface: #262420;
    --bg-elevated: #2e2c27;
    --bg-hover: #33312b;
    --bg-nav: #22201c;
    --border: #3d3a33;
    --border-subtle: #33312b;
    --text: #e8e4d9;
    --text-secondary: #a09b8a;
    --text-muted: #6b6758;
    --accent: #d4844e;
    --accent-dim: #b36a3a;
    --accent-glow: rgba(212, 132, 78, 0.12);
    --action: #6aaa64;
    --action-bg: rgba(106, 170, 100, 0.12);
    --reference: #6a9fd8;
    --reference-bg: rgba(106, 159, 216, 0.12);
    --done: #6b6758;
    --danger: #c45c5c;
    --danger-bg: rgba(196, 92, 92, 0.10);
    --pinned: #c9a84c;
    --pinned-bg: rgba(201, 168, 76, 0.12);
    --undo-bg: #e8e4d9;
    --undo-text: #1c1a16;
    --modal-overlay: rgba(28, 26, 22, 0.85);
  }

  :root {
    --radius: 8px;
    --radius-lg: 12px;
    --transition: 180ms ease;
    --font: 'Outfit', -apple-system, BlinkMacSystemFont, sans-serif;
    --mono: 'IBM Plex Mono', monospace;
    --shadow-sm: 0 1px 3px rgba(0,0,0,0.06);
    --shadow-md: 0 4px 16px rgba(0,0,0,0.07);
    --shadow-lg: 0 8px 32px rgba(0,0,0,0.10);
  }

  [data-theme="dark"] {
    --shadow-sm: 0 1px 3px rgba(0,0,0,0.2);
    --shadow-md: 0 4px 16px rgba(0,0,0,0.25);
    --shadow-lg: 0 8px 32px rgba(0,0,0,0.35);
  }

  * { margin: 0; padding: 0; box-sizing: border-box; }

  body {
    font-family: var(--font); background: var(--bg); color: var(--text);
    min-height: 100vh; line-height: 1.5; -webkit-font-smoothing: antialiased;
    transition: background 300ms ease, color 300ms ease;
  }

  .app {
    max-width: 720px; margin: 0 auto; padding: 0 20px;
    min-height: 100vh; display: flex; flex-direction: column;
  }

  /* ─── HEADER ─── */
  header {
    padding: 28px 0 20px; display: flex; align-items: center;
    justify-content: space-between; border-bottom: 1px solid var(--border-subtle);
  }

  .header-left { display: flex; align-items: center; gap: 14px; }
  .logo { display: flex; align-items: center; gap: 10px; }

  .logo-mark {
    width: 28px; height: 28px; border-radius: 6px;
    background: linear-gradient(135deg, var(--accent), var(--accent-dim));
    display: flex; align-items: center; justify-content: center;
    font-size: 14px; font-weight: 700; color: #fff;
  }

  .logo-text { font-size: 17px; font-weight: 600; letter-spacing: -0.02em; color: var(--text); }
  .logo-text span { color: var(--accent); }

  .theme-toggle {
    width: 32px; height: 32px; border-radius: 6px; border: 1px solid var(--border-subtle);
    background: transparent; cursor: pointer; display: flex; align-items: center;
    justify-content: center; font-size: 15px; transition: all var(--transition);
    color: var(--text-muted);
  }
  .theme-toggle:hover { border-color: var(--border); color: var(--text-secondary); background: var(--bg-hover); }

  nav { display: flex; gap: 2px; background: var(--bg-nav); padding: 3px; border-radius: var(--radius); }

  nav button {
    font-family: var(--font); font-size: 13px; font-weight: 500; padding: 7px 16px;
    border: none; background: transparent; color: var(--text-muted); border-radius: 6px;
    cursor: pointer; transition: all var(--transition); position: relative;
  }
  nav button:hover { color: var(--text-secondary); }
  nav button.active { background: var(--bg-surface); color: var(--text); box-shadow: var(--shadow-sm); }

  nav button .badge {
    position: absolute; top: 2px; right: 4px; background: var(--accent); color: #fff;
    font-size: 10px; font-weight: 700; min-width: 16px; height: 16px; border-radius: 8px;
    display: flex; align-items: center; justify-content: center; padding: 0 4px;
  }

  main { flex: 1; padding: 32px 0; }

  /* ─── CAPTURE ─── */
  .capture-view {
    display: flex; flex-direction: column; align-items: center;
    justify-content: center; min-height: 50vh;
  }

  .capture-prompt {
    font-size: 13px; font-weight: 500; color: var(--text-muted);
    text-transform: uppercase; letter-spacing: 0.08em; margin-bottom: 20px;
  }

  .capture-input-wrap { width: 100%; position: relative; }

  .capture-input {
    width: 100%; font-family: var(--font); font-size: 20px; font-weight: 400;
    padding: 20px 24px; background: var(--bg-surface); border: 1.5px solid var(--border);
    border-radius: var(--radius-lg); color: var(--text); outline: none;
    transition: all var(--transition); resize: none; line-height: 1.5;
    min-height: 70px; box-shadow: var(--shadow-sm);
  }
  .capture-input::placeholder { color: var(--text-muted); }
  .capture-input:focus { border-color: var(--accent); box-shadow: 0 0 0 3px var(--accent-glow), var(--shadow-md); }

  .capture-char-count {
    position: absolute; bottom: 8px; right: 14px; font-family: var(--mono);
    font-size: 10px; color: var(--text-muted); opacity: 0; transition: opacity 200ms;
  }
  .capture-input:focus ~ .capture-char-count { opacity: 1; }

  .capture-meta { width: 100%; display: flex; align-items: flex-start; gap: 10px; margin-top: 14px; }

  .tag-container {
    flex: 1; position: relative;
    background: var(--bg-surface); border: 1px solid var(--border-subtle);
    border-radius: var(--radius); box-shadow: var(--shadow-sm);
    display: flex; flex-wrap: wrap; align-items: center; gap: 6px;
    padding: 6px 10px; transition: all var(--transition); min-height: 42px;
  }
  .tag-container:focus-within { border-color: var(--accent); box-shadow: 0 0 0 2px var(--accent-glow); }

  .tag-chip {
    display: inline-flex; align-items: center; gap: 4px;
    background: var(--bg-nav); color: var(--text);
    font-size: 13px; padding: 2px 8px; border-radius: 4px;
    animation: chipIn 150ms ease;
  }
  @keyframes chipIn { from { opacity: 0; transform: scale(0.8); } to { opacity: 1; transform: scale(1); } }
  .tag-chip .tag-remove { cursor: pointer; opacity: 0.5; font-size: 14px; margin-left: 2px; line-height: 1; }
  .tag-chip .tag-remove:hover { opacity: 1; color: var(--danger); }

  .tag-select-input {
    flex: 1; min-width: 80px; font-family: var(--font); font-size: 14px;
    border: none; background: transparent; color: var(--text); outline: none; padding: 4px 0;
  }
  .tag-select-input::placeholder { color: var(--text-muted); }

  .tag-dropdown {
    position: absolute; top: calc(100% + 4px); left: 0; right: 0;
    background: var(--bg-surface); border: 1px solid var(--border);
    border-radius: var(--radius); box-shadow: var(--shadow-lg); z-index: 100;
    max-height: 200px; overflow-y: auto; display: none;
  }
  .tag-dropdown.open { display: block; }

  .tag-option {
    padding: 9px 16px; font-size: 13px; cursor: pointer;
    color: var(--text-secondary); transition: background var(--transition);
  }
  .tag-option:hover, .tag-option.highlighted { background: var(--bg-hover); color: var(--text); }
  .tag-option.create-new { color: var(--accent); border-top: 1px solid var(--border-subtle); font-weight: 500; }

  .capture-btn {
    font-family: var(--font); font-size: 14px; font-weight: 600; padding: 10px 24px;
    background: linear-gradient(135deg, var(--accent), var(--accent-dim)); color: #fff;
    border: none; border-radius: var(--radius); cursor: pointer;
    transition: all var(--transition); white-space: nowrap; height: 42px;
    box-shadow: 0 2px 8px rgba(194, 106, 58, 0.2);
  }
  .capture-btn:hover { transform: translateY(-1px); box-shadow: 0 4px 16px rgba(194, 106, 58, 0.3); }
  .capture-btn:active { transform: translateY(0); }

  .capture-hint { margin-top: 16px; font-size: 12px; color: var(--text-muted); font-family: var(--mono); }
  .capture-hint kbd {
    background: var(--bg-surface); padding: 2px 6px; border-radius: 4px;
    border: 1px solid var(--border-subtle); font-size: 11px; box-shadow: 0 1px 0 var(--border);
  }

  /* ─── FLASH / UNDO TOAST ─── */
  .capture-flash {
    position: fixed; top: 20px; left: 50%;
    transform: translateX(-50%) translateY(-60px);
    background: var(--bg-surface); border: 1px solid var(--accent); color: var(--accent);
    padding: 10px 24px; border-radius: var(--radius); font-size: 14px; font-weight: 500;
    opacity: 0; transition: all 300ms ease; z-index: 200; pointer-events: none;
    box-shadow: var(--shadow-md);
  }
  .capture-flash.show { opacity: 1; transform: translateX(-50%) translateY(0); }

  .undo-toast {
    position: fixed; bottom: 24px; left: 50%;
    transform: translateX(-50%) translateY(80px);
    background: var(--undo-bg); color: var(--undo-text);
    padding: 12px 20px; border-radius: var(--radius); font-size: 14px;
    display: flex; align-items: center; gap: 14px;
    opacity: 0; transition: all 300ms ease; z-index: 200;
    box-shadow: 0 8px 24px rgba(0,0,0,0.2);
  }
  .undo-toast.show { opacity: 1; transform: translateX(-50%) translateY(0); }
  .undo-toast button {
    font-family: var(--font); font-size: 13px; font-weight: 600; padding: 4px 14px;
    background: var(--accent); color: #fff; border: none; border-radius: 5px;
    cursor: pointer; transition: opacity 150ms;
  }
  .undo-toast button:hover { opacity: 0.85; }
  .undo-toast .undo-dismiss {
    background: transparent; color: var(--undo-text); opacity: 0.5; padding: 4px 8px;
    font-size: 16px;
  }

  /* ─── REVIEW ─── */
  .review-header { display: flex; align-items: center; justify-content: space-between; margin-bottom: 8px; flex-wrap: wrap; gap: 8px; }
  .review-title { font-size: 22px; font-weight: 600; letter-spacing: -0.02em; }
  .review-count { font-size: 13px; color: var(--text-muted); font-family: var(--mono); }

  .review-bulk-bar {
    display: flex; gap: 6px; margin-bottom: 16px; flex-wrap: wrap;
  }
  .bulk-btn {
    font-family: var(--font); font-size: 11px; font-weight: 500; padding: 4px 12px;
    border: 1px solid var(--border-subtle); background: transparent;
    border-radius: 20px; cursor: pointer; transition: all var(--transition);
    color: var(--text-muted);
  }
  .bulk-btn:hover { border-color: var(--border); color: var(--text-secondary); background: var(--bg-hover); }
  .bulk-btn.bulk-action:hover { color: var(--action); background: var(--action-bg); border-color: rgba(90,138,82,0.3); }
  .bulk-btn.bulk-ref:hover { color: var(--reference); background: var(--reference-bg); border-color: rgba(90,130,170,0.3); }

  .review-empty { text-align: center; padding: 80px 20px; color: var(--text-muted); }
  .review-empty-icon { font-size: 40px; margin-bottom: 16px; opacity: 0.4; color: var(--accent); }
  .review-empty h3 { font-size: 17px; font-weight: 500; color: var(--text-secondary); margin-bottom: 6px; }
  .review-empty p { font-size: 14px; }

  .item-card {
    background: var(--bg-surface); border: 1px solid var(--border-subtle);
    border-radius: var(--radius-lg); padding: 18px 20px; margin-bottom: 10px;
    transition: all var(--transition); animation: slideIn 250ms ease; box-shadow: var(--shadow-sm);
    position: relative;
  }
  @keyframes slideIn { from { opacity: 0; transform: translateY(8px); } to { opacity: 1; transform: translateY(0); } }
  .item-card:hover { border-color: var(--border); box-shadow: var(--shadow-md); }
  .item-card.pinned { border-left: 3px solid var(--pinned); }
  .item-card.review-focus { border-color: var(--accent); box-shadow: 0 0 0 2px var(--accent-glow); }

  .item-text-edit {
    width: 100%; font-family: var(--font); font-size: 15px; line-height: 1.6;
    margin-bottom: 12px; background: transparent; border: none; resize: none;
    color: var(--text); padding: 0; outline: none; min-height: 24px;
    border-radius: 4px; transition: background 0.2s; overflow: hidden;
  }
  .item-text-edit:focus { background: var(--bg-hover); padding: 4px; margin: -4px -4px 12px -4px; }

  .item-text { font-size: 15px; line-height: 1.6; margin-bottom: 12px; white-space: pre-wrap; word-break: break-word; }
  .item-card.completed .item-text { color: var(--text-muted); text-decoration: line-through; opacity: 0.8; }

  .item-footer { display: flex; align-items: center; justify-content: space-between; flex-wrap: wrap; gap: 8px; }
  .item-meta { display: flex; align-items: center; gap: 8px; flex-wrap: wrap; font-size: 12px; color: var(--text-muted); font-family: var(--mono); }

  .item-tag {
    display: inline-flex; align-items: center; padding: 3px 10px;
    background: var(--accent-glow); color: var(--accent); border-radius: 20px;
    font-size: 12px; font-weight: 500; font-family: var(--font);
  }

  .item-actions { display: flex; gap: 6px; flex-wrap: wrap; }

  .item-action-btn {
    font-family: var(--font); font-size: 12px; font-weight: 500; padding: 5px 12px;
    border: 1px solid var(--border-subtle); background: transparent;
    border-radius: 6px; cursor: pointer; transition: all var(--transition);
    -webkit-tap-highlight-color: transparent;
  }
  .item-action-btn:active { transform: scale(0.95); }
  .item-action-btn.action-type { color: var(--action); border-color: rgba(90, 138, 82, 0.3); }
  .item-action-btn.action-type:hover { background: var(--action-bg); }
  .item-action-btn.reference-type { color: var(--reference); border-color: rgba(90, 130, 170, 0.3); }
  .item-action-btn.reference-type:hover { background: var(--reference-bg); }
  .item-action-btn.done-type { color: var(--text-muted); }
  .item-action-btn.done-type:hover { background: var(--bg-hover); }
  .item-action-btn.delete-type { color: var(--danger); border-color: rgba(184, 84, 80, 0.2); }
  .item-action-btn.delete-type:hover { background: var(--danger-bg); }
  .item-action-btn.complete-type { color: var(--action); border-color: rgba(90, 138, 82, 0.3); }
  .item-action-btn.complete-type:hover { background: var(--action-bg); }
  .item-action-btn.pin-type { color: var(--pinned); border-color: rgba(201, 168, 76, 0.3); }
  .item-action-btn.pin-type:hover { background: var(--pinned-bg); }
  .item-action-btn.pin-type.is-pinned { background: var(--pinned-bg); font-weight: 600; }

  /* ─── RETRIEVE ─── */
  .retrieve-controls { display: flex; gap: 10px; margin-bottom: 16px; flex-wrap: wrap; }

  .input-wrap { flex: 1; min-width: 180px; position: relative; }
  .input-wrap input {
    width: 100%; font-family: var(--font); font-size: 14px; padding: 10px 32px 10px 16px;
    background: var(--bg-surface); border: 1px solid var(--border-subtle);
    border-radius: var(--radius); color: var(--text); outline: none;
    transition: all var(--transition); box-shadow: var(--shadow-sm);
  }
  .input-wrap input:focus { border-color: var(--accent); box-shadow: 0 0 0 2px var(--accent-glow); }
  .input-wrap input::placeholder { color: var(--text-muted); }

  .input-clear {
    position: absolute; right: 8px; top: 50%; transform: translateY(-50%);
    width: 20px; height: 20px; border-radius: 50%; border: none;
    background: var(--bg-hover); color: var(--text-muted); cursor: pointer;
    font-size: 13px; display: none; align-items: center; justify-content: center;
    transition: all var(--transition); line-height: 1;
  }
  .input-clear:hover { background: var(--border); color: var(--text); }
  .input-wrap.has-value .input-clear { display: flex; }

  .retrieve-toolbar { display: flex; align-items: center; justify-content: space-between; margin-bottom: 16px; flex-wrap: wrap; gap: 8px; }

  .type-filters { display: flex; gap: 6px; flex-wrap: wrap; }

  .type-filter-btn {
    font-family: var(--font); font-size: 12px; font-weight: 500; padding: 5px 12px;
    border: 1px solid var(--border-subtle); background: transparent; border-radius: 20px;
    cursor: pointer; transition: all var(--transition); color: var(--text-muted);
  }
  .type-filter-btn:hover { color: var(--text-secondary); }
  .type-filter-btn.active-all { background: var(--bg-hover); color: var(--text); border-color: var(--border); }
  .type-filter-btn.active-action { background: var(--action-bg); color: var(--action); border-color: rgba(90, 138, 82, 0.3); }
  .type-filter-btn.active-reference { background: var(--reference-bg); color: var(--reference); border-color: rgba(90, 130, 170, 0.3); }
  .type-filter-btn.active-unprocessed { background: var(--accent-glow); color: var(--accent); border-color: rgba(194, 106, 58, 0.3); }
  .type-filter-btn.active-completed { background: var(--bg-nav); color: var(--text-secondary); border-color: var(--border); }

  .sort-select {
    font-family: var(--font); font-size: 12px; padding: 4px 8px;
    border: 1px solid var(--border-subtle); background: var(--bg-surface);
    border-radius: 6px; color: var(--text-secondary); cursor: pointer;
    outline: none;
  }

  .retrieve-results-count { font-size: 12px; color: var(--text-muted); font-family: var(--mono); margin-bottom: 16px; }

  .date-group-label {
    font-size: 11px; font-weight: 600; text-transform: uppercase; letter-spacing: 0.06em;
    color: var(--text-muted); padding: 12px 0 6px; border-bottom: 1px solid var(--border-subtle);
    margin-bottom: 10px;
  }

  .retrieve-item .item-text { font-size: 14px; margin-bottom: 10px; }

  .item-type-badge {
    font-size: 11px; font-weight: 600; text-transform: uppercase;
    letter-spacing: 0.05em; padding: 2px 8px; border-radius: 4px; font-family: var(--font);
  }
  .item-type-badge.action { background: var(--action-bg); color: var(--action); }
  .item-type-badge.reference { background: var(--reference-bg); color: var(--reference); }
  .item-type-badge.unprocessed { background: var(--accent-glow); color: var(--accent); }
  .item-type-badge.completed { background: var(--bg-nav); color: var(--text-muted); }

  .pin-indicator { color: var(--pinned); font-size: 12px; margin-right: 2px; }

  /* ─── SETTINGS ─── */
  .settings-bar {
    padding: 16px 0; border-top: 1px solid var(--border-subtle);
    display: flex; align-items: center; justify-content: space-between; flex-wrap: wrap; gap: 10px;
  }
  .settings-left { display: flex; align-items: center; gap: 8px; flex-wrap: wrap; }
  .settings-bar .subtle-btn {
    font-family: var(--mono); font-size: 11px; padding: 6px 12px;
    border: 1px solid var(--border-subtle); background: transparent;
    color: var(--text-muted); border-radius: 6px; cursor: pointer; transition: all var(--transition);
  }
  .settings-bar .subtle-btn:hover { border-color: var(--border); color: var(--text-secondary); background: var(--bg-hover); }
  .settings-bar .subtle-btn.danger:hover { border-color: rgba(184, 84, 80, 0.3); color: var(--danger); background: var(--danger-bg); }
  .stats-text { font-family: var(--mono); font-size: 11px; color: var(--text-muted); }

  .sync-status { width: 8px; height: 8px; border-radius: 50%; background: var(--border); display: inline-block; margin-right: 4px; vertical-align: middle; }
  .sync-status.ok { background: var(--action); }
  .sync-status.error { background: var(--danger); }
  .sync-status.loading { background: var(--accent); animation: pulse 1s infinite; }
  @keyframes pulse { 0% { opacity: 1; } 50% { opacity: 0.4; } 100% { opacity: 1; } }

  /* ─── MODAL ─── */
  .modal-overlay {
    position: fixed; inset: 0; background: var(--modal-overlay);
    backdrop-filter: blur(6px); z-index: 500; display: none;
    align-items: center; justify-content: center; padding: 20px;
  }
  .modal-overlay.open { display: flex; }
  .modal {
    background: var(--bg-surface); border: 1px solid var(--border);
    border-radius: var(--radius-lg); padding: 28px; max-width: 480px;
    width: 100%; box-shadow: var(--shadow-lg);
  }
  .modal h3 { font-size: 17px; font-weight: 600; margin-bottom: 12px; }
  .modal p { font-size: 14px; color: var(--text-secondary); margin-bottom: 16px; line-height: 1.6; }
  .modal-input {
    width: 100%; padding: 10px 14px; margin-bottom: 16px;
    border: 1px solid var(--border); border-radius: var(--radius);
    font-family: var(--font); font-size: 14px; color: var(--text);
    background: var(--bg-surface); outline: none;
  }
  .modal-input:focus { border-color: var(--accent); box-shadow: 0 0 0 2px var(--accent-glow); }
  .modal-actions { display: flex; gap: 10px; justify-content: flex-end; }
  .modal-btn {
    font-family: var(--font); font-size: 13px; font-weight: 500; padding: 8px 20px;
    border-radius: var(--radius); cursor: pointer; transition: all var(--transition);
    border: 1px solid var(--border); background: transparent; color: var(--text-secondary);
  }
  .modal-btn:hover { color: var(--text); background: var(--bg-hover); }
  .modal-btn.primary { background: var(--accent); border-color: var(--accent); color: #fff; }
  .modal-btn.primary:hover { opacity: 0.9; }
  .modal-btn.confirm-danger { background: var(--danger); border-color: var(--danger); color: #fff; }

  /* ─── RESPONSIVE ─── */
  @media (max-width: 600px) {
    .app { padding: 0 14px; }
    header { padding: 20px 0 16px; flex-wrap: wrap; gap: 12px; }
    .capture-input { font-size: 17px; padding: 16px 18px; }
    .capture-meta { flex-direction: column; }
    .capture-btn { width: 100%; text-align: center; }
    nav button { padding: 7px 12px; font-size: 12px; }
    .retrieve-controls { flex-direction: column; }
    .item-footer { flex-direction: column; align-items: flex-start; }
    .item-action-btn { padding: 8px 16px; font-size: 13px; }
    .settings-bar { flex-direction: column; align-items: flex-start; }
  }

  ::-webkit-scrollbar { width: 6px; }
  ::-webkit-scrollbar-track { background: transparent; }
  ::-webkit-scrollbar-thumb { background: var(--border); border-radius: 3px; }
  ::-webkit-scrollbar-thumb:hover { background: var(--text-muted); }

  .hidden { display: none !important; }
</style>
</head>
<body data-theme="light">

<div class="app">
  <header>
    <div class="header-left">
      <div class="logo">
        <div class="logo-mark">C</div>
        <div class="logo-text">Cog<span>Capture</span></div>
      </div>
      <button class="theme-toggle" id="theme-toggle" title="Toggle dark mode">☀</button>
    </div>
    <nav id="nav">
      <button class="active" data-view="capture">Capture</button>
      <button data-view="review">Review <span class="badge hidden" id="review-badge">0</span></button>
      <button data-view="retrieve">Retrieve</button>
    </nav>
  </header>

  <main>
    <section id="view-capture" class="capture-view">
      <div class="capture-prompt">What's on your mind?</div>
      <div class="capture-input-wrap">
        <textarea class="capture-input" id="capture-input" placeholder="Quick thought, action item, or idea..." rows="2"></textarea>
        <div class="capture-char-count" id="char-count">0</div>
      </div>
      <div class="capture-meta">
        <div class="tag-container" id="tag-container">
          <input type="text" class="tag-select-input" id="tag-input" placeholder="Add tags..." autocomplete="off">
          <div class="tag-dropdown" id="tag-dropdown"></div>
        </div>
        <button class="capture-btn" id="capture-btn">Capture</button>
      </div>
      <div class="capture-hint"><kbd>Ctrl</kbd>+<kbd>Enter</kbd> capture · <kbd>/</kbd> focus from anywhere</div>
    </section>

    <section id="view-review" class="hidden">
      <div class="review-header">
        <h2 class="review-title">Review</h2>
        <span class="review-count" id="review-count"></span>
      </div>
      <div class="review-bulk-bar" id="review-bulk-bar" style="display:none;">
        <button class="bulk-btn bulk-action" id="bulk-action">All → Action</button>
        <button class="bulk-btn bulk-ref" id="bulk-ref">All → Reference</button>
      </div>
      <div id="review-list"></div>
    </section>

    <section id="view-retrieve" class="hidden">
      <div class="retrieve-controls">
        <div class="input-wrap" id="search-wrap">
          <input type="text" id="search-input" placeholder="Search captures...">
          <button class="input-clear" id="search-clear">&times;</button>
        </div>
        <div class="input-wrap" id="filter-wrap">
          <input type="text" id="filter-tag-input" placeholder="Filter by tag..." autocomplete="off">
          <button class="input-clear" id="filter-clear">&times;</button>
          <div class="tag-dropdown" id="filter-tag-dropdown"></div>
        </div>
      </div>
      <div class="retrieve-toolbar">
        <div class="type-filters" id="type-filters">
          <button class="type-filter-btn active-all" data-type="all">All</button>
          <button class="type-filter-btn" data-type="unprocessed">Inbox</button>
          <button class="type-filter-btn" data-type="action">Actions</button>
          <button class="type-filter-btn" data-type="reference">Reference</button>
          <button class="type-filter-btn" data-type="completed">Done</button>
        </div>
        <select class="sort-select" id="sort-select">
          <option value="newest">Newest</option>
          <option value="oldest">Oldest</option>
        </select>
      </div>
      <div class="retrieve-results-count" id="retrieve-count"></div>
      <div id="retrieve-list"></div>
    </section>
  </main>

  <div class="settings-bar">
    <div class="settings-left">
      <div id="sync-indicator" class="sync-status" title="Not connected"></div>
      <span class="stats-text" id="stats-text"></span>
    </div>
    <div style="display:flex;gap:8px;flex-wrap:wrap;">
      <button class="subtle-btn" id="cloud-btn">Sync</button>
      <button class="subtle-btn" id="export-btn">Export</button>
      <button class="subtle-btn" id="import-btn">Import</button>
      <button class="subtle-btn danger" id="clear-btn">Clear</button>
    </div>
  </div>
</div>

<div class="capture-flash" id="capture-flash">✓ Captured</div>

<div class="undo-toast" id="undo-toast">
  <span id="undo-text">Item dismissed</span>
  <button id="undo-btn">Undo</button>
  <button class="undo-dismiss" id="undo-dismiss">&times;</button>
</div>

<div class="modal-overlay" id="modal-overlay">
  <div class="modal">
    <h3 id="modal-title">Confirm</h3>
    <p id="modal-body">Are you sure?</p>
    <div id="modal-content"></div>
    <div class="modal-actions">
      <button class="modal-btn" id="modal-cancel">Cancel</button>
      <button class="modal-btn primary" id="modal-confirm">Confirm</button>
    </div>
  </div>
</div>

<input type="file" id="import-file" accept=".json" style="display:none">

<script>
// ═══════════════════════════════════════════
// DATA LAYER
// ═══════════════════════════════════════════
const STORAGE_KEY = 'cogcapture_data';
const CLOUD_URL_KEY = 'cogcapture_cloud_url';
const THEME_KEY = 'cogcapture_theme';

function loadData() {
  try {
    const raw = localStorage.getItem(STORAGE_KEY);
    if (raw) {
      const d = JSON.parse(raw);
      // Data integrity: ensure arrays exist
      if (!Array.isArray(d.items)) d.items = [];
      if (!Array.isArray(d.tags)) d.tags = [];
      // Ensure every item has required fields
      d.items = d.items.filter(i => i && typeof i.id === 'string' && typeof i.text === 'string');
      d.items.forEach(i => {
        if (!Array.isArray(i.tags)) i.tags = i.tag ? [i.tag] : [];
        if (!i.type) i.type = 'unprocessed';
        if (!i.createdAt) i.createdAt = new Date().toISOString();
        if (typeof i.pinned === 'undefined') i.pinned = false;
        delete i.tag; // Clean up legacy field
      });
      return d;
    }
  } catch (e) { console.error('Data load error:', e); }
  return { items: [], tags: [] };
}

let _suppressSync = false;

function saveData(d) {
  localStorage.setItem(STORAGE_KEY, JSON.stringify(d));
  if (!_suppressSync) triggerCloudSync(d);
}

let data = loadData();

// ═══════════════════════════════════════════
// CLOUD SYNC (Secured)
// ═══════════════════════════════════════════
let cloudUrl = localStorage.getItem(CLOUD_URL_KEY) || '';
const syncIndicator = document.getElementById('sync-indicator');
let syncTimeout = null;
let lastSyncTime = null;

function setSyncStatus(status, title) {
  syncIndicator.className = 'sync-status ' + status;
  syncIndicator.title = title || status;
}

function validateCloudUrl(url) {
  if (!url) return false;
  try {
    const u = new URL(url);
    // Only allow Google Apps Script URLs
    return u.hostname === 'script.google.com' && u.pathname.startsWith('/macros/s/');
  } catch { return false; }
}

function validateCloudData(d) {
  if (!d || typeof d !== 'object') return false;
  if (!Array.isArray(d.items)) return false;
  // Validate each item has at minimum an id and text
  return d.items.every(i => i && typeof i.id === 'string' && typeof i.text === 'string');
}

function sanitizeCloudItem(item) {
  return {
    id: String(item.id).slice(0, 50),
    text: String(item.text).slice(0, 10000),
    tags: Array.isArray(item.tags) ? item.tags.map(t => String(t).slice(0, 100)).slice(0, 20) : [],
    type: ['unprocessed','action','reference','completed'].includes(item.type) ? item.type : 'unprocessed',
    createdAt: item.createdAt || new Date().toISOString(),
    processedAt: item.processedAt || null,
    pinned: !!item.pinned
  };
}

function fetchCloudData() {
  if (!cloudUrl || !validateCloudUrl(cloudUrl)) return;
  setSyncStatus('loading', 'Pulling...');
  fetch(cloudUrl, {
    method: 'GET',
    redirect: 'follow'  // Apps Script returns 302 → follow it
  })
    .then(r => {
      if (!r.ok) throw new Error('HTTP ' + r.status);
      return r.json();
    })
    .then(cloudData => {
      // Check for Apps Script error response
      if (cloudData.error) {
        setSyncStatus('error', 'Server: ' + cloudData.error);
        return;
      }
      if (!validateCloudData(cloudData)) {
        setSyncStatus('error', 'Invalid cloud data');
        return;
      }
      const safeItems = cloudData.items.map(sanitizeCloudItem);
      const cloudMap = new Map(safeItems.map(i => [i.id, i]));
      const localMap = new Map(data.items.map(i => [i.id, i]));

      // Merge: for items in both, keep whichever was modified more recently
      const mergedMap = new Map();
      for (const [id, item] of cloudMap) {
        const local = localMap.get(id);
        if (!local) { mergedMap.set(id, item); continue; }
        // Compare processedAt or createdAt for recency
        const cloudTime = new Date(item.processedAt || item.createdAt);
        const localTime = new Date(local.processedAt || local.createdAt);
        mergedMap.set(id, localTime > cloudTime ? local : item);
      }
      // Add local-only items
      for (const [id, item] of localMap) {
        if (!mergedMap.has(id)) mergedMap.set(id, item);
      }

      _suppressSync = true;
      data.items = Array.from(mergedMap.values());
      data.items.sort((a, b) => new Date(b.createdAt) - new Date(a.createdAt));

      if (Array.isArray(cloudData.tags)) {
        cloudData.tags.forEach(t => {
          const clean = String(t).slice(0, 100);
          if (clean && !data.tags.includes(clean)) data.tags.push(clean);
        });
      }
      saveData(data);
      _suppressSync = false;

      // Push merged data back so both sides are in sync
      pushToCloud(data);

      renderCurrentView();
      lastSyncTime = new Date();
      setSyncStatus('ok', 'Synced ' + formatTime(lastSyncTime.toISOString()));
    })
    .catch(e => {
      console.error('Cloud fetch error:', e);
      _suppressSync = false;
      setSyncStatus('error', 'Pull failed: ' + e.message);
    });
}

function pushToCloud(d) {
  if (!cloudUrl || !validateCloudUrl(cloudUrl)) return Promise.resolve();
  return fetch(cloudUrl, {
    method: 'POST',
    redirect: 'follow',
    body: JSON.stringify(d)
    // No Content-Type header — avoids CORS preflight entirely
  })
    .then(r => {
      lastSyncTime = new Date();
      setSyncStatus('ok', 'Synced ' + formatTime(lastSyncTime.toISOString()));
    })
    .catch(e => {
      console.error('Cloud push error:', e);
      setSyncStatus('error', 'Push failed: ' + e.message);
    });
}

function triggerCloudSync(d) {
  if (!cloudUrl || !validateCloudUrl(cloudUrl)) return;
  setSyncStatus('loading', 'Saving...');
  clearTimeout(syncTimeout);
  syncTimeout = setTimeout(() => pushToCloud(d), 1500);
}

// Auto-sync on tab focus
document.addEventListener('visibilitychange', () => {
  if (!document.hidden && cloudUrl) fetchCloudData();
});

// Initial sync
if (cloudUrl && validateCloudUrl(cloudUrl)) {
  setSyncStatus('loading', 'Connecting...');
  setTimeout(fetchCloudData, 500);
} else if (cloudUrl && !validateCloudUrl(cloudUrl)) {
  setSyncStatus('error', 'Invalid sync URL');
}

// ═══════════════════════════════════════════
// ITEM OPERATIONS
// ═══════════════════════════════════════════
function addItem(text, tags) {
  const item = {
    id: Date.now().toString(36) + Math.random().toString(36).slice(2, 6),
    text: text.trim(),
    tags: (tags || []).map(t => t.trim()).filter(Boolean),
    type: 'unprocessed',
    createdAt: new Date().toISOString(),
    processedAt: null,
    pinned: false
  };
  data.items.unshift(item);
  item.tags.forEach(t => { if (!data.tags.includes(t)) data.tags.push(t); });
  data.tags.sort((a, b) => a.toLowerCase().localeCompare(b.toLowerCase()));
  saveData(data);
  return item;
}

function updateItemText(id, newText) {
  const item = data.items.find(i => i.id === id);
  if (item) { item.text = newText.trim(); saveData(data); }
}

function updateItemType(id, type) {
  const item = data.items.find(i => i.id === id);
  if (item) { item.type = type; item.processedAt = new Date().toISOString(); saveData(data); }
}

function togglePin(id) {
  const item = data.items.find(i => i.id === id);
  if (item) { item.pinned = !item.pinned; saveData(data); }
}

function deleteItem(id) {
  const idx = data.items.findIndex(i => i.id === id);
  if (idx === -1) return null;
  const removed = data.items.splice(idx, 1)[0];
  saveData(data);
  return removed;
}

function restoreItem(item) {
  if (!item) return;
  data.items.push(item);
  data.items.sort((a, b) => new Date(b.createdAt) - new Date(a.createdAt));
  saveData(data);
}

function getUnprocessed() { return data.items.filter(i => i.type === 'unprocessed'); }

function search(query, tag, type, sort) {
  let r = data.items;
  if (type && type !== 'all') r = r.filter(i => i.type === type);
  if (tag) r = r.filter(i => Array.isArray(i.tags) && i.tags.some(t => t.toLowerCase() === tag.toLowerCase()));
  if (query) {
    const q = query.toLowerCase();
    r = r.filter(i => i.text.toLowerCase().includes(q) || (Array.isArray(i.tags) && i.tags.some(t => t.toLowerCase().includes(q))));
  }
  // Pinned items first, then by date
  r.sort((a, b) => {
    if (a.pinned && !b.pinned) return -1;
    if (!a.pinned && b.pinned) return 1;
    const da = new Date(a.createdAt), db = new Date(b.createdAt);
    return sort === 'oldest' ? da - db : db - da;
  });
  return r;
}

// ═══════════════════════════════════════════
// UNDO SYSTEM
// ═══════════════════════════════════════════
let undoStack = [];
let undoTimer = null;
const undoToast = document.getElementById('undo-toast');
const undoText = document.getElementById('undo-text');

function pushUndo(label, item) {
  undoStack = [{ label, item }]; // Only keep last action
  undoText.textContent = label;
  undoToast.classList.add('show');
  clearTimeout(undoTimer);
  undoTimer = setTimeout(() => {
    undoToast.classList.remove('show');
    undoStack = [];
  }, 6000);
}

document.getElementById('undo-btn').addEventListener('click', () => {
  if (undoStack.length === 0) return;
  const { item } = undoStack.pop();
  restoreItem(item);
  undoToast.classList.remove('show');
  clearTimeout(undoTimer);
  renderCurrentView();
});

document.getElementById('undo-dismiss').addEventListener('click', () => {
  undoToast.classList.remove('show');
  clearTimeout(undoTimer);
  undoStack = [];
});

// ═══════════════════════════════════════════
// THEME
// ═══════════════════════════════════════════
const themeToggle = document.getElementById('theme-toggle');
let currentTheme = localStorage.getItem(THEME_KEY) || 'light';
applyTheme(currentTheme);

function applyTheme(theme) {
  currentTheme = theme;
  document.body.setAttribute('data-theme', theme);
  themeToggle.textContent = theme === 'dark' ? '☾' : '☀';
  localStorage.setItem(THEME_KEY, theme);
}

themeToggle.addEventListener('click', () => {
  applyTheme(currentTheme === 'dark' ? 'light' : 'dark');
});

// ═══════════════════════════════════════════
// VIEW MANAGEMENT
// ═══════════════════════════════════════════
const views = ['capture', 'review', 'retrieve'];
let currentView = 'capture';

function switchView(view) {
  currentView = view;
  views.forEach(v => document.getElementById(`view-${v}`).classList.toggle('hidden', v !== view));
  document.querySelectorAll('#nav button').forEach(btn => btn.classList.toggle('active', btn.dataset.view === view));
  if (view === 'review') renderReview();
  if (view === 'retrieve') renderRetrieve();
  if (view === 'capture') document.getElementById('capture-input').focus();
  updateBadge(); updateStats();
}

document.querySelectorAll('#nav button').forEach(btn => btn.addEventListener('click', () => switchView(btn.dataset.view)));

// ═══════════════════════════════════════════
// CAPTURE
// ═══════════════════════════════════════════
const captureInput = document.getElementById('capture-input');
const tagInput = document.getElementById('tag-input');
const tagContainer = document.getElementById('tag-container');
const tagDropdown = document.getElementById('tag-dropdown');
const captureFlash = document.getElementById('capture-flash');
const charCount = document.getElementById('char-count');
let activeTags = [];

captureInput.addEventListener('input', () => {
  captureInput.style.height = 'auto';
  captureInput.style.height = Math.max(70, captureInput.scrollHeight) + 'px';
  charCount.textContent = captureInput.value.length;
});

function renderActiveTags() {
  tagContainer.querySelectorAll('.tag-chip').forEach(c => c.remove());
  activeTags.forEach((t, i) => {
    const chip = document.createElement('div');
    chip.className = 'tag-chip';
    chip.innerHTML = escapeHtml(t) + ' <span class="tag-remove" data-index="' + i + '">&times;</span>';
    tagContainer.insertBefore(chip, tagInput);
  });
}

tagContainer.addEventListener('click', (e) => {
  if (e.target.classList.contains('tag-remove')) {
    activeTags.splice(parseInt(e.target.dataset.index), 1);
    renderActiveTags();
  } else if (e.target === tagContainer) {
    tagInput.focus();
  }
});

function addActiveTag(tagStr) {
  const clean = tagStr.trim();
  if (clean && !activeTags.includes(clean)) {
    activeTags.push(clean);
    renderActiveTags();
  }
  tagInput.value = '';
}

function doCapture() {
  const text = captureInput.value.trim();
  if (!text) { captureInput.focus(); return; }
  if (tagInput.value.trim()) addActiveTag(tagInput.value);
  addItem(text, [...activeTags]);
  captureInput.value = '';
  captureInput.style.height = 'auto';
  charCount.textContent = '0';
  activeTags = [];
  renderActiveTags();
  tagInput.value = '';
  tagDropdown.classList.remove('open');
  showFlash('Captured');
  captureInput.focus();
  updateBadge(); updateStats();
}

document.getElementById('capture-btn').addEventListener('click', doCapture);
captureInput.addEventListener('keydown', (e) => {
  if (e.key === 'Enter' && (e.ctrlKey || e.metaKey)) { e.preventDefault(); doCapture(); }
});

// ═══════════════════════════════════════════
// TAG AUTOCOMPLETE
// ═══════════════════════════════════════════
function setupTagAutocomplete(input, dropdown, onSelect) {
  let highlighted = -1;
  function render() {
    const val = input.value.toLowerCase();
    const matches = data.tags.filter(t => t.toLowerCase().includes(val));
    let html = '';
    matches.forEach((t, i) => {
      html += '<div class="tag-option" data-tag="' + escapeAttr(t) + '" data-index="' + i + '">' + escapeHtml(t) + '</div>';
    });
    if (val && !data.tags.some(t => t.toLowerCase() === val)) {
      html += '<div class="tag-option create-new" data-tag="' + escapeAttr(input.value.trim()) + '" data-index="' + matches.length + '">+ Create "' + escapeHtml(input.value.trim()) + '"</div>';
    }
    dropdown.innerHTML = html;
    highlighted = -1;
    if (html) dropdown.classList.add('open'); else dropdown.classList.remove('open');
  }
  function selectOption(tag) {
    if (onSelect) onSelect(tag); else input.value = tag;
    dropdown.classList.remove('open');
  }
  input.addEventListener('input', render);
  input.addEventListener('focus', render);
  input.addEventListener('keydown', (e) => {
    const options = dropdown.querySelectorAll('.tag-option');
    if (e.key === 'Enter') {
      if (dropdown.classList.contains('open') && highlighted >= 0) {
        e.preventDefault(); selectOption(options[highlighted].dataset.tag);
      } else if (input.value.trim()) {
        e.preventDefault();
        if (onSelect) onSelect(input.value.trim());
      }
    } else if (e.key === 'ArrowDown') {
      if (!dropdown.classList.contains('open')) return;
      e.preventDefault(); highlighted = Math.min(highlighted + 1, options.length - 1);
      options.forEach((o, i) => o.classList.toggle('highlighted', i === highlighted));
    } else if (e.key === 'ArrowUp') {
      if (!dropdown.classList.contains('open')) return;
      e.preventDefault(); highlighted = Math.max(highlighted - 1, 0);
      options.forEach((o, i) => o.classList.toggle('highlighted', i === highlighted));
    } else if (e.key === 'Escape') {
      dropdown.classList.remove('open');
    } else if (e.key === ',' && onSelect) {
      e.preventDefault();
      if (input.value.trim()) onSelect(input.value.trim());
    }
  });
  dropdown.addEventListener('click', (e) => {
    const opt = e.target.closest('.tag-option');
    if (opt) selectOption(opt.dataset.tag);
  });
  document.addEventListener('click', (e) => {
    if (!input.contains(e.target) && !dropdown.contains(e.target) && !e.target.closest('.tag-container'))
      dropdown.classList.remove('open');
  });
}

setupTagAutocomplete(tagInput, tagDropdown, (tag) => addActiveTag(tag));
const filterTagInput = document.getElementById('filter-tag-input');
const filterTagDropdown = document.getElementById('filter-tag-dropdown');
setupTagAutocomplete(filterTagInput, filterTagDropdown, (tag) => {
  filterTagInput.value = tag;
  filterTagDropdown.classList.remove('open');
  updateInputWrap('filter-wrap', tag);
  renderRetrieve();
});
filterTagInput.addEventListener('input', () => {
  updateInputWrap('filter-wrap', filterTagInput.value);
  if (!filterTagInput.value) renderRetrieve();
});

// Clear buttons
document.getElementById('search-clear').addEventListener('click', () => {
  document.getElementById('search-input').value = '';
  updateInputWrap('search-wrap', '');
  renderRetrieve();
});
document.getElementById('filter-clear').addEventListener('click', () => {
  filterTagInput.value = '';
  updateInputWrap('filter-wrap', '');
  renderRetrieve();
});

function updateInputWrap(id, val) {
  document.getElementById(id).classList.toggle('has-value', !!val);
}

document.getElementById('search-input').addEventListener('input', function() {
  updateInputWrap('search-wrap', this.value);
  renderRetrieve();
});

// ═══════════════════════════════════════════
// REVIEW
// ═══════════════════════════════════════════
let reviewFocusIdx = -1;

function renderReview() {
  const list = document.getElementById('review-list');
  const items = getUnprocessed();
  document.getElementById('review-count').textContent = items.length + ' unprocessed';
  document.getElementById('review-bulk-bar').style.display = items.length > 1 ? 'flex' : 'none';
  reviewFocusIdx = -1;

  if (items.length === 0) {
    list.innerHTML = '<div class="review-empty"><div class="review-empty-icon">◇</div><h3>All clear</h3><p>Nothing to process. Capture some ideas first.</p></div>';
    return;
  }

  list.innerHTML = items.map((item, idx) => `
    <div class="item-card" data-id="${escapeAttr(item.id)}" data-review-idx="${idx}">
      <textarea class="item-text-edit" data-id="${escapeAttr(item.id)}">${escapeTextareaContent(item.text)}</textarea>
      <div class="item-footer">
        <div class="item-meta">
          ${(item.tags||[]).map(t => '<span class="item-tag">' + escapeHtml(t) + '</span>').join('')}
          <span>${formatTime(item.createdAt)}</span>
        </div>
        <div class="item-actions">
          <button class="item-action-btn action-type" data-action="action" data-id="${escapeAttr(item.id)}">Action</button>
          <button class="item-action-btn reference-type" data-action="reference" data-id="${escapeAttr(item.id)}">Reference</button>
          <button class="item-action-btn done-type" data-action="done" data-id="${escapeAttr(item.id)}">Dismiss</button>
        </div>
      </div>
    </div>`).join('');

  // Event handlers
  list.querySelectorAll('.item-action-btn').forEach(btn => {
    btn.addEventListener('click', () => {
      const id = btn.dataset.id, action = btn.dataset.action;
      if (action === 'done') {
        const removed = deleteItem(id);
        if (removed) pushUndo('Item dismissed', removed);
      } else {
        updateItemType(id, action);
      }
      renderReview(); updateBadge(); updateStats();
    });
  });

  // Auto-size textareas & edit handling
  list.querySelectorAll('textarea.item-text-edit').forEach(area => {
    autoSizeTextarea(area);
    area.addEventListener('input', () => autoSizeTextarea(area));
    area.addEventListener('blur', () => {
      const item = data.items.find(i => i.id === area.dataset.id);
      if (item && item.text !== area.value) updateItemText(area.dataset.id, area.value);
    });
  });
}

function autoSizeTextarea(el) {
  el.style.height = 'auto';
  el.style.height = el.scrollHeight + 'px';
}

// Bulk actions
document.getElementById('bulk-action').addEventListener('click', () => {
  getUnprocessed().forEach(i => updateItemType(i.id, 'action'));
  renderReview(); updateBadge(); updateStats();
});
document.getElementById('bulk-ref').addEventListener('click', () => {
  getUnprocessed().forEach(i => updateItemType(i.id, 'reference'));
  renderReview(); updateBadge(); updateStats();
});

// ═══════════════════════════════════════════
// RETRIEVE
// ═══════════════════════════════════════════
let activeType = 'all';

document.querySelectorAll('#type-filters .type-filter-btn').forEach(btn => {
  btn.addEventListener('click', () => {
    activeType = btn.dataset.type;
    document.querySelectorAll('#type-filters .type-filter-btn').forEach(b => b.className = 'type-filter-btn');
    const clsMap = { all: 'active-all', action: 'active-action', reference: 'active-reference', unprocessed: 'active-unprocessed', completed: 'active-completed' };
    btn.classList.add(clsMap[activeType] || 'active-all');
    renderRetrieve();
  });
});

document.getElementById('sort-select').addEventListener('change', () => renderRetrieve());

function renderRetrieve() {
  const query = document.getElementById('search-input').value;
  const tag = filterTagInput.value;
  const sort = document.getElementById('sort-select').value;
  const results = search(query, tag, activeType, sort);
  const list = document.getElementById('retrieve-list');
  document.getElementById('retrieve-count').textContent = results.length + ' item' + (results.length !== 1 ? 's' : '');

  if (results.length === 0) {
    list.innerHTML = '<div class="review-empty"><div class="review-empty-icon">◇</div><h3>No results</h3><p>Try adjusting your search or filters.</p></div>';
    return;
  }

  // Group by date
  const groups = groupByDate(results);
  let html = '';

  for (const [label, items] of groups) {
    html += '<div class="date-group-label">' + escapeHtml(label) + '</div>';
    html += items.map(item => {
      const isCompleted = item.type === 'completed';
      const typeCls = item.type === 'action' ? 'action' : item.type === 'reference' ? 'reference' : item.type === 'completed' ? 'completed' : 'unprocessed';
      const typeLabel = item.type === 'action' ? 'Action' : item.type === 'reference' ? 'Reference' : item.type === 'completed' ? 'Done' : 'Inbox';
      return `
      <div class="item-card retrieve-item ${isCompleted ? 'completed' : ''} ${item.pinned ? 'pinned' : ''}" data-id="${escapeAttr(item.id)}">
        <div class="item-text">${item.pinned ? '<span class="pin-indicator">⚑</span> ' : ''}${escapeHtml(item.text)}</div>
        <div class="item-footer">
          <div class="item-meta">
            <span class="item-type-badge ${typeCls}">${typeLabel}</span>
            ${(item.tags||[]).map(t => '<span class="item-tag">' + escapeHtml(t) + '</span>').join('')}
            <span>${formatTime(item.createdAt)}</span>
          </div>
          <div class="item-actions">
            <button class="item-action-btn pin-type ${item.pinned ? 'is-pinned' : ''}" data-action="pin" data-id="${escapeAttr(item.id)}">${item.pinned ? 'Unpin' : 'Pin'}</button>
            ${!isCompleted && item.type === 'action' ? '<button class="item-action-btn complete-type" data-action="completed" data-id="' + escapeAttr(item.id) + '">Complete</button>' : ''}
            <button class="item-action-btn delete-type" data-action="delete" data-id="${escapeAttr(item.id)}">Delete</button>
          </div>
        </div>
      </div>`;
    }).join('');
  }

  list.innerHTML = html;

  list.querySelectorAll('.item-action-btn').forEach(btn => {
    btn.addEventListener('click', () => {
      const id = btn.dataset.id, action = btn.dataset.action;
      if (action === 'delete') {
        const removed = deleteItem(id);
        if (removed) pushUndo('Item deleted', removed);
      } else if (action === 'pin') {
        togglePin(id);
      } else if (action === 'completed') {
        updateItemType(id, 'completed');
      }
      renderRetrieve(); updateBadge(); updateStats();
    });
  });
}

function groupByDate(items) {
  const groups = new Map();
  const now = new Date();
  const today = new Date(now.getFullYear(), now.getMonth(), now.getDate());
  const yesterday = new Date(today); yesterday.setDate(today.getDate() - 1);
  const weekAgo = new Date(today); weekAgo.setDate(today.getDate() - 7);

  items.forEach(item => {
    const d = new Date(item.createdAt);
    let label;
    if (d >= today) label = 'Today';
    else if (d >= yesterday) label = 'Yesterday';
    else if (d >= weekAgo) label = 'This Week';
    else label = d.toLocaleDateString('en-GB', { month: 'long', year: 'numeric' });

    if (!groups.has(label)) groups.set(label, []);
    groups.get(label).push(item);
  });

  return groups;
}

// ═══════════════════════════════════════════
// BADGE & STATS
// ═══════════════════════════════════════════
function updateBadge() {
  const count = getUnprocessed().length;
  const badge = document.getElementById('review-badge');
  badge.textContent = count;
  badge.classList.toggle('hidden', count === 0);
}

function updateStats() {
  const total = data.items.length;
  const actions = data.items.filter(i => i.type === 'action').length;
  const completed = data.items.filter(i => i.type === 'completed').length;
  const inbox = getUnprocessed().length;
  document.getElementById('stats-text').textContent =
    total + ' total · ' + inbox + ' inbox · ' + actions + ' actions · ' + completed + ' done';
}

// ═══════════════════════════════════════════
// MODAL (Secured)
// ═══════════════════════════════════════════
let modalCallback = null;
const modal = {
  overlay: document.getElementById('modal-overlay'),
  title: document.getElementById('modal-title'),
  body: document.getElementById('modal-body'),
  content: document.getElementById('modal-content'),
  cancel: document.getElementById('modal-cancel'),
  confirm: document.getElementById('modal-confirm'),
  open(title, body, contentBuilder, onConfirm, confirmText, isDanger) {
    modal.title.textContent = title;
    modal.body.textContent = body;
    modal.content.innerHTML = '';
    if (contentBuilder) contentBuilder(modal.content); // Safe DOM building
    modal.confirm.textContent = confirmText || 'Confirm';
    modal.confirm.className = isDanger ? 'modal-btn confirm-danger' : 'modal-btn primary';
    modal.overlay.classList.add('open');
    modalCallback = onConfirm;
    // Focus the first input if present
    const firstInput = modal.content.querySelector('input');
    if (firstInput) setTimeout(() => firstInput.focus(), 100);
  },
  close() { modal.overlay.classList.remove('open'); modalCallback = null; }
};
modal.cancel.addEventListener('click', modal.close);
modal.confirm.addEventListener('click', () => { if (modalCallback) modalCallback(); modal.close(); });
modal.overlay.addEventListener('click', (e) => { if (e.target === modal.overlay) modal.close(); });

// ═══════════════════════════════════════════
// SETTINGS ACTIONS
// ═══════════════════════════════════════════
document.getElementById('export-btn').addEventListener('click', () => {
  const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url;
  a.download = 'cogcapture-' + new Date().toISOString().slice(0, 10) + '.json';
  a.click();
  URL.revokeObjectURL(url);
});

document.getElementById('import-btn').addEventListener('click', () => document.getElementById('import-file').click());
document.getElementById('import-file').addEventListener('change', (e) => {
  const file = e.target.files[0]; if (!file) return;
  const reader = new FileReader();
  reader.onload = () => {
    try {
      const imported = JSON.parse(reader.result);
      if (imported.items && Array.isArray(imported.items)) {
        const existingIds = new Set(data.items.map(i => i.id));
        let count = 0;
        imported.items.forEach(i => {
          if (!existingIds.has(i.id)) {
            // Sanitize & migrate
            if (!Array.isArray(i.tags)) i.tags = i.tag ? [i.tag] : [];
            if (!i.type) i.type = 'unprocessed';
            if (!i.createdAt) i.createdAt = new Date().toISOString();
            i.pinned = !!i.pinned;
            delete i.tag;
            data.items.push(i);
            count++;
          }
        });
        if (imported.tags) imported.tags.forEach(t => { if (!data.tags.includes(t)) data.tags.push(t); });
        data.items.sort((a, b) => new Date(b.createdAt) - new Date(a.createdAt));
        saveData(data);
        renderCurrentView();
        showFlash('Imported ' + count + ' items');
      } else { throw new Error('Invalid'); }
    } catch (err) { alert('Invalid file format. Expected CogCapture JSON.'); }
  };
  reader.readAsText(file);
  e.target.value = '';
});

document.getElementById('clear-btn').addEventListener('click', () => {
  modal.open('Clear all data?', 'This permanently deletes all captures, tags, and history.', null, () => {
    data = { items: [], tags: [] };
    saveData(data);
    renderCurrentView();
  }, 'Clear All', true);
});

document.getElementById('cloud-btn').addEventListener('click', () => {
  modal.open(
    'Cloud Sync',
    'Paste your Google Apps Script Web App URL to sync data across devices.',
    (container) => {
      const input = document.createElement('input');
      input.type = 'text';
      input.className = 'modal-input';
      input.id = 'cloud-url-input';
      input.placeholder = 'https://script.google.com/macros/s/...';
      input.value = cloudUrl;
      container.appendChild(input);

      if (lastSyncTime) {
        const info = document.createElement('p');
        info.style.fontSize = '12px';
        info.style.color = 'var(--text-muted)';
        info.textContent = 'Last synced: ' + lastSyncTime.toLocaleString();
        container.appendChild(info);
      }
    },
    () => {
      const url = document.getElementById('cloud-url-input').value.trim();
      if (url && validateCloudUrl(url)) {
        localStorage.setItem(CLOUD_URL_KEY, url);
        cloudUrl = url;
        fetchCloudData();
      } else if (url) {
        alert('Please enter a valid Google Apps Script URL (https://script.google.com/macros/s/...)');
      } else {
        localStorage.removeItem(CLOUD_URL_KEY);
        cloudUrl = '';
        setSyncStatus('', 'Not connected');
      }
    },
    'Save'
  );
});

// ═══════════════════════════════════════════
// HELPERS
// ═══════════════════════════════════════════
function escapeHtml(str) {
  if (typeof str !== 'string') return '';
  const div = document.createElement('div');
  div.textContent = str;
  return div.innerHTML;
}

function escapeAttr(str) {
  if (typeof str !== 'string') return '';
  return str.replace(/&/g, '&amp;').replace(/"/g, '&quot;').replace(/'/g, '&#39;').replace(/</g, '&lt;').replace(/>/g, '&gt;');
}

function escapeTextareaContent(str) {
  if (typeof str !== 'string') return '';
  // Prevent breaking out of textarea with </textarea> in content
  return str.replace(/</g, '&lt;').replace(/>/g, '&gt;');
}

function formatTime(iso) {
  const d = new Date(iso), now = new Date(), diff = now - d;
  if (diff < 60000) return 'just now';
  if (diff < 3600000) return Math.floor(diff / 60000) + 'm ago';
  if (diff < 86400000) return Math.floor(diff / 3600000) + 'h ago';
  if (diff < 172800000) return 'yesterday';
  return d.toLocaleDateString('en-GB', { day: 'numeric', month: 'short' });
}

function showFlash(text) {
  captureFlash.textContent = '✓ ' + text;
  captureFlash.classList.add('show');
  setTimeout(() => captureFlash.classList.remove('show'), 1200);
}

function renderCurrentView() {
  if (currentView === 'review') renderReview();
  if (currentView === 'retrieve') renderRetrieve();
  updateBadge();
  updateStats();
}

// ═══════════════════════════════════════════
// KEYBOARD SHORTCUTS
// ═══════════════════════════════════════════
document.addEventListener('keydown', (e) => {
  const tag = e.target.tagName;
  const isInput = tag === 'INPUT' || tag === 'TEXTAREA' || tag === 'SELECT';

  // Global: / to focus capture from anywhere
  if (e.key === '/' && !isInput) {
    e.preventDefault();
    switchView('capture');
    captureInput.focus();
    return;
  }

  // Escape to close modal
  if (e.key === 'Escape') {
    if (modal.overlay.classList.contains('open')) { modal.close(); return; }
    if (undoToast.classList.contains('show')) { undoToast.classList.remove('show'); return; }
  }

  if (isInput) return;

  // View switching
  if (e.key === '1') switchView('capture');
  if (e.key === '2') switchView('review');
  if (e.key === '3') switchView('retrieve');

  // Review keyboard nav: j/k to move, a/r/d to action
  if (currentView === 'review') {
    const cards = document.querySelectorAll('#review-list .item-card');
    if (cards.length === 0) return;

    if (e.key === 'j' || e.key === 'ArrowDown') {
      e.preventDefault();
      reviewFocusIdx = Math.min(reviewFocusIdx + 1, cards.length - 1);
      cards.forEach((c, i) => c.classList.toggle('review-focus', i === reviewFocusIdx));
      cards[reviewFocusIdx].scrollIntoView({ block: 'nearest', behavior: 'smooth' });
    }
    if (e.key === 'k' || e.key === 'ArrowUp') {
      e.preventDefault();
      reviewFocusIdx = Math.max(reviewFocusIdx - 1, 0);
      cards.forEach((c, i) => c.classList.toggle('review-focus', i === reviewFocusIdx));
      cards[reviewFocusIdx].scrollIntoView({ block: 'nearest', behavior: 'smooth' });
    }
    if (reviewFocusIdx >= 0 && reviewFocusIdx < cards.length) {
      const id = cards[reviewFocusIdx].dataset.id;
      if (e.key === 'a') { updateItemType(id, 'action'); renderReview(); updateBadge(); updateStats(); }
      if (e.key === 'r') { updateItemType(id, 'reference'); renderReview(); updateBadge(); updateStats(); }
      if (e.key === 'd') {
        const removed = deleteItem(id);
        if (removed) pushUndo('Item dismissed', removed);
        renderReview(); updateBadge(); updateStats();
      }
    }
  }
});

// ═══════════════════════════════════════════
// INIT
// ═══════════════════════════════════════════
updateBadge();
updateStats();
captureInput.focus();
</script>
</body>
</html>
